#!/bin/sh

parameters=$@
readval=
err=

echo "脆弱性チェック対象をスペース区切りで入力して下さい"
echo "入力されたチェック対象ソフトウェアの依存関係、プロセスマッピング情報、アップデートするかの確認を行います"
read readvals
vals=`echo $readvals | sed "s/ /|/g"`


function check_processes
{
for process in `sudo egrep "${@}" /proc/[0-9]*/maps | awk -F "/" '{print $3}' | uniq `; do
    ps -ef | awk -F " " '{print $2 "\t" $8}' | grep -w $process | grep -v grep | grep -v  "\["
done
}

function show_deleted_process
{
    for process in `sudo egrep "${@}" /proc/[0-9]*/maps | grep deleted | awk -F "/" '{print $3}' | uniq `; do
        ps -ef | awk -F " " '{print $2 "\t" $8}' | grep -w $process | egrep -v "grep|egrep" | grep -v  "\["
    done
}

function check_rpm
{
    local var=
    for var in $@;do
        rpm -qa | grep $var
    done
}

function check_whatrequires
{
    local var=
    for var in $@;do
        rpm -q --whatrequires $var
    done
}

function check_deleted
{
    show_deleted_process "deleted"
}

echo ===================== process list =====================
check_processes ${vals}

echo ===================== checking rpm =====================
check_rpm ${readvals}

echo ===================== checking dependency =====================
check_whatrequires ${readvals}

echo "アップデートしますか？[y/N]"

isUpdate=
read isUpdate

if [ ${isUpdate} = "y" -o ${isUpdate} = "Y" ]; then
    sudo yum update -y ${readvals}
fi

echo ===================== checking all deleted library =====================
check_deleted

echo ===================== checking deleted library =====================
show_deleted_process ${vals}

echo ===================== show process list =====================
sudo chkconfig --list 


