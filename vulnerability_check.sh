#!/bin/sh

#parameters=$@
readval=
err=

echo "脆弱性チェック対象をスペース区切りで入力して下さい"
echo "入力されたチェック対象ソフトウェアの依存関係、プロセスマッピング情報、アップデートするかの確認を行います"
read readvals

if [ -z "${readvals}" ]; then
    echo "入力がありません."
    exit
fi

if [ "${readvals}" = " " ]; then
    echo "入力がありません."
    exit
fi

vals=`echo $readvals | sed "s/ /|/g"`


function check_processes
{
for process in `sudo egrep "${@}" /proc/[0-9]*/maps | awk -F "/" '{print $3}' | uniq `; do
    ps -ef | awk -F " " '{print $2 "\t" $8}' | grep -w $process | grep -v grep | grep -v  "\["
done
}

function show_deleted_process
{
    for process in `sudo egrep "${@}" /proc/[0-9]*/maps | grep deleted | awk -F "/" '{print $3}' | uniq `; do
        ps -ef | awk -F " " '{print $2 "\t" $8}' | grep -w $process | egrep -v "grep|egrep" | grep -v  "\["
    done
}

function show_alternatives
{
    for process in $@; do
        echo ===================== show alternatives ${process} =====================
        sudo alternatives --display ${process}
    done
}

function check_rpm
{
    local var=
    for var in $@;do
        sudo rpm -qa | grep $var
    done
}

function check_whatrequires
{
    local var=
    for var in $@;do
        sudo rpm -q --whatrequires $var
    done
}

function check_deleted
{
    show_deleted_process "deleted"
}

echo ===================== process list of using vunlnerability software =====================
check_processes ${vals}

echo ===================== checking installed vunlnerability rpm =====================
check_rpm ${readvals}

echo ===================== checking dependency of rpm =====================
check_whatrequires ${readvals}

echo "======${readvals}をアップデートしますか？[y/N]======"

isUpdate=
read isUpdate

if [ ${isUpdate} = "y" -o ${isUpdate} = "Y" ]; then
    sudo yum update -y ${readvals}
fi

echo ===================== checking all deleted library after update =====================
check_deleted

echo ===================== checking deleted vunlnerability library to need to restart of daemon =====================
show_deleted_process ${vals}

echo ===================== show daemon list =====================
sudo chkconfig --list

show_alternatives ${readvals}

exit
